<?php

namespace App\Models\Audit;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“š AUDIT EXERCISE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class AuditExercise extends Model
{
    use SoftDeletes;

    protected $table = 'audit_exercises';
    protected $fillable = [
        'tenant_id', 'code', 'name', 'description', 'year',
        'start_date', 'end_date', 'status', 'is_active',
        'objectives', 'scope', 'methodology', 'manager_id',
        'created_by', 'total_sessions', 'completed_sessions',
        'total_risks_identified'
    ];

    protected $casts = [
        'start_date' => 'date',
        'end_date' => 'date',
        'is_active' => 'boolean',
    ];

    public function sessions()
    {
        return $this->hasMany(AuditSession::class, 'exercise_id');
    }

    public function creator()
    {
        return $this->belongsTo(\App\Models\User::class, 'created_by');
    }

    public function manager()
    {
        return $this->belongsTo(\App\Models\User::class, 'manager_id');
    }

    public function getStatusLabelAttribute()
    {
        return match ($this->status) {
            'draft' => 'ğŸ“ Brouillon',
            'planning' => 'ğŸ“‹ Planification',
            'in_progress' => 'ğŸ”„ En cours',
            'closing' => 'â³ ClÃ´ture',
            'closed' => 'ğŸ”’ FermÃ©',
            'completed' => 'âœ… ComplÃ©tÃ©',
            default => $this->status,
        };
    }

    public function getStatusColorAttribute()
    {
        return match ($this->status) {
            'draft' => 'secondary',
            'planning' => 'info',
            'in_progress' => 'primary',
            'closing' => 'warning',
            'closed' => 'danger',
            'completed' => 'success',
            default => 'secondary',
        };
    }

    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    public function scopeByYear($query, $year)
    {
        return $query->where('year', $year);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ AUDIT SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ SESSION RISK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class SessionRisk extends Model
{
    use SoftDeletes;

    protected $table = 'session_risks';
    protected $fillable = [
        'tenant_id', 'audit_session_id', 'risk_id', 'code', 'label',
        'description', 'risk_type_id', 'process_id', 'activity_id',
        'frequency_level_id', 'impact_level_id', 'criticality',
        'frequency_net', 'impact_net', 'control_procedure', 'owner',
        'validation_status', 'validation_comments', 'validated_at',
        'validated_by', 'color', 'created_by'
    ];

    protected $casts = [
        'validated_at' => 'datetime',
    ];

    public function session()
    {
        return $this->belongsTo(AuditSession::class, 'audit_session_id');
    }

    public function risk()
    {
        return $this->belongsTo(Risk::class, 'risk_id');
    }

    public function creator()
    {
        return $this->belongsTo(\App\Models\User::class, 'created_by');
    }

    public function validator()
    {
        return $this->belongsTo(\App\Models\User::class, 'validated_by');
    }

    public function getStatusLabelAttribute()
    {
        return match ($this->validation_status) {
            'draft' => 'âœï¸ Brouillon',
            'pending' => 'â³ En attente',
            'approved' => 'âœ… ApprouvÃ©',
            'rejected' => 'âŒ RejetÃ©',
            default => $this->validation_status,
        };
    }

    public function getColorValueAttribute()
    {
        return match ($this->color) {
            'warning' => '#ffc107',
            'success' => '#28a745',
            'danger' => '#dc3545',
            default => '#6c757d',
        };
    }

    public function scopeApproved($query)
    {
        return $query->where('validation_status', 'approved');
    }

    public function scopeRejected($query)
    {
        return $query->where('validation_status', 'rejected');
    }

    public function scopePending($query)
    {
        return $query->where('validation_status', 'pending');
    }

    public function scopeBySession($query, $sessionId)
    {
        return $query->where('audit_session_id', $sessionId);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š REFERENCE MODELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class RiskType extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'tenant_id', 'code', 'label', 'description',
        'color', 'sort_order', 'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean',
    ];
}

class RiskFrequencyLevel extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'tenant_id', 'code', 'label', 'level',
        'description', 'color'
    ];
}

class RiskImpactLevel extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'tenant_id', 'code', 'label', 'level',
        'description', 'color'
    ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ RISK (Table principale)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Risk extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'tenant_id', 'project_id', 'audit_session_id', 'entity_id',
        'process_id', 'activity_id', 'risk_type_id', 'code', 'label',
        'description', 'activity_code', 'frequency_level_id',
        'frequency_net', 'impact_level_id', 'impact_net', 'criticality',
        'owner', 'control_procedure', 'status', 'year',
        'created_by', 'updated_by'
    ];

    public function session()
    {
        return $this->belongsTo(AuditSession::class, 'audit_session_id');
    }

    public function riskType()
    {
        return $this->belongsTo(RiskType::class, 'risk_type_id');
    }

    public function frequencyLevel()
    {
        return $this->belongsTo(RiskFrequencyLevel::class, 'frequency_level_id');
    }

    public function impactLevel()
    {
        return $this->belongsTo(RiskImpactLevel::class, 'impact_level_id');
    }

    public function sessionRisks()
    {
        return $this->hasMany(SessionRisk::class, 'risk_id');
    }

    public function scopeBySession($query, $sessionId)
    {
        return $query->where('audit_session_id', $sessionId);
    }

    public function scopeByStatus($query, $status)
    {
        return $query->where('status', $status);
    }

    public function scopeByYear($query, $year)
    {
        return $query->where('year', $year);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›ï¸ ENTITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Entity extends Model
{
    use SoftDeletes;

    protected $table = 'entities';

    protected $fillable = [
        'tenant_id', 'code_base', 'name', 'description',
        'level', 'parent_id'
    ];

    public function parent()
    {
        return $this->belongsTo($this, 'parent_id');
    }

    public function children()
    {
        return $this->hasMany($this, 'parent_id');
    }
}